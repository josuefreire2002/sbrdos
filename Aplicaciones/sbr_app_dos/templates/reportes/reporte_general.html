{% extends 'base.html' %}
{% load humanize %}

{% block title %}Reporte General | SBR Gestión{% endblock %}
{% block breadcrumb %}Reporte General de Pagos{% endblock %}

{% block extra_head %}
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<style>
    .table-report thead th {
        background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        color: white;
        font-size: 0.75rem;
        text-transform: uppercase;
        white-space: nowrap;
        padding: 0.75rem 0.5rem;
    }

    .table-report tbody td {
        font-size: 0.85rem;
        padding: 0.5rem;
        white-space: nowrap;
    }

    .payment-cell {
        text-align: right;
        font-weight: 500;
    }

    .payment-cell.has-payment {
        background-color: #d1fae5;
        color: #065f46;
    }

    .payment-cell.no-payment {
        color: #9ca3af;
    }

    .payment-cell.devolucion-payment {
        background-color: #fee2e2 !important;
        color: #dc2626 !important;
        font-weight: 600;
    }

    .table-report tfoot td {
        background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        color: white;
        font-weight: 700;
        font-size: 0.85rem;
        padding: 0.75rem 0.5rem;
        border-top: 3px solid #1e40af;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .table-report tfoot td.text-success {
        background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        color: white;
        font-size: 0.95rem;
    }

    @media print {
        @page {
            size: landscape;
            margin: 0.5cm;
        }

        body {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        .no-print,
        .sidebar,
        header,
        nav,
        footer {
            display: none !important;
        }

        .main-content,
        .card,
        .container-fluid {
            margin: 0 !important;
            padding: 0 !important;
            box-shadow: none !important;
        }

        .table-report {
            font-size: 7px !important;
            width: 100% !important;
        }

        .table-report thead th {
            background: #1e40af !important;
            color: white !important;
            font-size: 6px !important;
            padding: 3px 2px !important;
        }

        .table-report tbody td {
            font-size: 7px !important;
            padding: 2px !important;
            white-space: normal !important;
            word-wrap: break-word;
        }

        .payment-cell.has-payment {
            background-color: #d1fae5 !important;
        }

        .payment-cell.devolucion-payment {
            background-color: #fee2e2 !important;
            color: #dc2626 !important;
        }

        .table-report tfoot {
            display: table-footer-group !important;
            visibility: visible !important;
            page-break-inside: avoid !important;
        }

        .table-report tfoot td {
            background: #1e40af !important;
            color: white !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
            font-size: 8px !important;
            padding: 5px 3px !important;
            font-weight: 700 !important;
            border: 1px solid #000 !important;
        }

        .table-report tfoot td.text-success {
            background: #059669 !important;
            color: white !important;
        }

        h4,
        h5 {
            font-size: 12px !important;
        }

        p {
            font-size: 9px !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="row g-4">
    <div class="col-12">
        <div class="card border-0 bg-white p-4 shadow-sm">
            <div
                class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between mb-4 gap-3">
                <div>
                    <h4 class="fw-bold mb-1">
                        <i class="bi bi-table me-2 text-primary"></i>Reporte General de Pagos
                    </h4>
                    <p class="text-muted mb-0">
                        Período: <strong>{{ desde|date:"M Y" }}</strong> - <strong>{{ hasta|date:"M Y" }}</strong>
                        {% if solo_activos %}<span class="badge bg-success ms-2">Solo Activos</span>{% endif %}
                    </p>
                </div>
                <div class="d-flex gap-2 no-print">
                    <a href="{% url 'lista_clientes' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-2"></i>Volver
                    </a>
                    <a href="{% url 'reporte_general_pdf' %}?desde={{ request.GET.desde }}&hasta={{ request.GET.hasta }}{% if solo_activos %}&solo_activos=on{% endif %}"
                        class="btn btn-danger">
                        <i class="bi bi-file-pdf me-2"></i>Descargar PDF
                    </a>
                </div>
            </div>

            <div class="table-responsive">
                <table id="reporteTable" class="table table-bordered table-report align-middle mb-0" style="width:100%">
                    <thead>
                        <tr>
                            <th class="text-center">#</th>
                            <th class="text-center">Estado</th>
                            <th>Apellidos / Nombres</th>
                            <th class="text-center">Cédula</th>
                            <th class="text-center">Email</th>
                            <th class="text-center">Celular</th>
                            <th class="text-center">Mz</th>
                            <th class="text-center">Lote</th>
                            <th class="text-end">V/Total</th>
                            <th class="text-end">Entrada</th>
                            <th class="text-end">Saldo</th>
                            <th class="text-end">Cuota</th>
                            {% for mes in meses %}
                            <th class="text-center">{{ mes.label }}</th>
                            {% endfor %}
                            <th class="text-end">Total Pagado</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in reporte_data %}
                        <tr>
                            <td class="text-center text-muted">{{ forloop.counter }}</td>
                            <td class="text-center">
                                {% if row.contrato.estado == 'CANCELADO' %}
                                <span class="badge bg-danger">Cancelado</span>
                                {% elif row.contrato.estado == 'DEVOLUCION' %}
                                <span class="badge bg-info">Devolución</span>
                                {% elif row.contrato.estado == 'CERRADO' %}
                                <span class="badge bg-secondary">Cerrado</span>
                                {% elif row.contrato.esta_en_mora %}
                                <span class="badge bg-warning text-dark">En Mora</span>
                                {% else %}
                                <span class="badge bg-success">Activo</span>
                                {% endif %}
                            </td>
                            <td>
                                <strong>{{ row.cliente.apellidos }}</strong> {{ row.cliente.nombres }}
                            </td>
                            <td class="text-center">{{ row.cliente.cedula }}</td>
                            <td class="text-center">{{ row.cliente.email }}</td>
                            <td class="text-center">{{ row.cliente.celular }}</td>
                            <td class="text-center fw-bold">{{ row.lote.manzana }}</td>
                            <td class="text-center">{{ row.lote.numero_lote }}</td>
                            <td class="text-end">${{ row.contrato.precio_venta_final|intcomma }}</td>
                            <td class="text-end">${{ row.contrato.valor_entrada|intcomma }}</td>
                            <td
                                class="text-end {% if row.saldo_pendiente > 0 %}text-warning{% elif row.saldo_pendiente == 0 %}text-success{% endif %}">
                                ${{ row.saldo_pendiente|intcomma }}
                            </td>
                            <td class="text-end">
                                {% with primera_cuota=row.contrato.cuotas.first %}
                                {% if primera_cuota %}
                                ${{ primera_cuota.valor_capital|floatformat:2 }}
                                {% else %}
                                -
                                {% endif %}
                                {% endwith %}
                            </td>
                            {% for pago in row.pagos_mensuales %}
                            <td
                                class="payment-cell {% if row.es_devolucion and pago > 0 %}devolucion-payment{% elif pago > 0 %}has-payment{% else %}no-payment{% endif %}">
                                {% if pago > 0 %}{% if row.es_devolucion %}-{% endif %}${{ pago|intcomma }}
                                {% else %}-{%endif %}
                            </td>
                            {% endfor %}
                            <td
                                class="text-end fw-bold {% if row.es_devolucion %}text-danger{% else %}text-success{% endif %}">
                                {% if row.es_devolucion %}-{% endif %}${{ row.total_pagado|intcomma }}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="{{ meses|length|add:12 }}" class="text-center py-4 text-muted">
                                No hay contratos para mostrar.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="8" class="text-end fw-bold">TOTALES:</td>
                            <td class="text-end fw-bold">${{ total_vtotal|intcomma }}</td>
                            <td class="text-end fw-bold">${{ total_entrada|intcomma }}</td>
                            <td class="text-end fw-bold">${{ total_saldo|intcomma }}</td>
                            <td class="text-end fw-bold">${{ total_cuotas|floatformat:2|intcomma }}</td>
                            <!-- Cuota -->
                            {% for total in totales_mensuales %}
                            <td class="text-end fw-bold">${{ total|intcomma }}</td>
                            {% endfor %}
                            <td class="text-end fw-bold">${{ total_general|intcomma }}</td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <!-- Totals Row (outside DataTable for proper printing) -->

        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script>
    $(document).ready(function () {
        $('#reporteTable').DataTable({
            paging: false,
            searching: true,
            ordering: true,
            info: false,
            scrollX: true,
            language: {
                search: "Buscar:",
                zeroRecords: "No se encontraron resultados"
            }
        });
    });
</script>
{% endblock %}