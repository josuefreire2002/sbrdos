{% extends 'base.html' %}

{% block title %}Inventario de Lotes | SBR Gestión{% endblock %}
{% block breadcrumb %}Inventario de Lotes{% endblock %}

{% block extra_head %}
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">
{% endblock %}

{% block content %}
<div class="row g-4">
    <div class="col-12">
        <div class="card border-0 bg-white p-4 overflow-hidden">
            <div class="d-md-flex align-items-center justify-content-between mb-4">
                <div>
                    <h4 class="fw-bold mb-1">Inventario de Lotes</h4>
                    <p class="text-muted mb-0">Gestión y control de todos los lotes disponibles.</p>
                </div>
                <div class="mt-3 mt-md-0">
                    <a href="{% url 'crear_lote' %}" class="btn btn-primary">
                        <i class="bi bi-plus-lg me-2"></i> Agregar Lote
                    </a>
                </div>
            </div>

            <!-- DataTable Container -->
            <div class="w-100 overflow-hidden">
                <table id="lotesTable" class="table table-hover align-middle nowrap" style="width:100%">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Manzana</th>
                            <th>N° Lote</th>
                            <th>Ciudad</th>
                            <th>Cantón</th>
                            <th>Parroquia</th>
                            <th>Provincia</th>

                            <th class="text-center">Imagen</th>
                            <th>Dimensiones</th>
                            <th class="text-end">Precio Contado</th>
                            <th class="text-center">Estado</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for lote in lotes %}
                        <tr>
                            <td class="text-muted small">#{{ lote.id }}</td>
                            <td class="fw-bold">{{ lote.manzana }}</td>
                            <td>{{ lote.numero_lote }}</td>
                            <td>{{ lote.ciudad|default:"-" }}</td>
                            <td>{{ lote.canton|default:"-" }}</td>
                            <td>{{ lote.parroquia|default:"-" }}</td>
                            <td>{{ lote.provincia|default:"-" }}</td>

                            <td class="text-center">
                                {% if lote.foto_lista %}
                                <a href="#" data-bs-toggle="modal" data-bs-target="#imgModal{{ lote.id }}">
                                    <img src="{{ lote.foto_lista.url }}" alt="Portada" class="img-thumbnail"
                                        style="max-height: 40px; max-width: 60px;">
                                </a>
                                {% elif lote.plano %}
                                <a href="#" data-bs-toggle="modal" data-bs-target="#imgModal{{ lote.id }}">
                                    <img src="{{ lote.plano.url }}" alt="Plano" class="img-thumbnail"
                                        style="max-height: 40px; max-width: 60px;">
                                </a>
                                {% else %}
                                <span class="text-muted small"><i class="bi bi-image"></i> --</span>
                                {% endif %}
                            </td>
                            <td>{{ lote.dimensiones }}</td>
                            <td class="text-end">${{ lote.precio_contado }}</td>
                            <td class="text-center">
                                {% if lote.estado == 'DISPONIBLE' %}
                                <span class="badge bg-success-subtle text-success px-3 py-2">DISPONIBLE</span>
                                {% elif lote.estado == 'VENDIDO' %}
                                <span class="badge bg-danger-subtle text-danger px-3 py-2">VENDIDO</span>
                                {% else %}
                                <span class="badge bg-warning-subtle text-warning px-3 py-2">{{ lote.estado }}</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if user.is_superuser or lote.creado_por == user %}
                                <a href="{% url 'editar_lote' lote.id %}" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-pencil me-1"></i> Editar
                                </a>
                                {% else %}
                                <span class="text-muted small">
                                    <i class="bi bi-lock me-1"></i> Sin acceso
                                </span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

        </div>
    </div>
</div>

<!-- Image Modals (outside of table for proper Bootstrap rendering) -->


{% for lote in lotes %}
{% if lote.foto_lista or lote.plano %}
<div class="modal fade" id="imgModal{{ lote.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Mz. {{ lote.manzana }} - Lote {{ lote.numero_lote }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body text-center p-0">
                {% if lote.foto_lista %}
                <img src="{{ lote.foto_lista.url }}" alt="Portada del lote" class="img-fluid mb-2">
                {% endif %}
                {% if lote.plano %}
                <img src="{{ lote.plano.url }}" alt="Plano del lote" class="img-fluid">
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endfor %}
{% endblock %}

{% block extra_js %}
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>

<script>
    $(document).ready(function () {
        $('#lotesTable').DataTable({
            responsive: false,
            scrollX: true,
            language: {
                "processing": "Procesando...",
                "lengthMenu": "Mostrar _MENU_ registros",
                "zeroRecords": "No se encontraron resultados",
                "emptyTable": "Ningún dato disponible en esta tabla",
                "info": "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
                "infoEmpty": "Mostrando registros del 0 al 0 de un total de 0 registros",
                "infoFiltered": "(filtrado de un total de _MAX_ registros)",
                "search": "Buscar:",
                "infoThousands": ",",
                "loadingRecords": "Cargando...",
                "paginate": {
                    "first": "Primero",
                    "last": "Último",
                    "next": "Siguiente",
                    "previous": "Anterior"
                },
                "aria": {
                    "sortAscending": ": Activar para ordenar la columna de manera ascendente",
                    "sortDescending": ": Activar para ordenar la columna de manera descendente"
                }
            },
            pageLength: 10,
            lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "Todos"]],
            order: [[1, 'asc'], [2, 'asc']],
            columnDefs: [
                { orderable: false, targets: [7, 11] } // Disable sorting on Imagen and Actions columns
            ],
            dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
                '<"row"<"col-sm-12"tr>>' +
                '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>'
        });
    });
</script>

<style>
    /* DataTables Custom Styling */
    .dataTables_wrapper {
        padding: 0;
    }

    .dataTables_filter input {
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        padding: 0.5rem 1rem;
        margin-left: 0.5rem;
        transition: all 0.2s;
    }

    .dataTables_filter input:focus {
        outline: none;
        border-color: var(--accent-color);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .dataTables_length select {
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        padding: 0.375rem 2rem 0.375rem 0.75rem;
        margin: 0 0.5rem;
    }

    .dataTables_info {
        padding-top: 1rem;
        color: #64748b;
        font-size: 0.875rem;
    }

    .dataTables_paginate {
        padding-top: 1rem;
    }

    .page-link {
        border-radius: 0.5rem;
        margin: 0 0.125rem;
        color: var(--accent-color);
        border: 1px solid #e2e8f0;
        transition: all 0.2s;
    }

    .page-link:hover {
        background-color: var(--accent-color);
        color: white;
        border-color: var(--accent-color);
        transform: translateY(-1px);
    }

    .page-item.active .page-link {
        background: var(--accent-gradient);
        border-color: transparent;
        box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
    }

    #lotesTable thead th {
        background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        color: white;
        font-weight: 600;
        border: none;
        padding: 1rem;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    #lotesTable tbody tr {
        border-bottom: 1px solid #e2e8f0;
        transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), background-color 0.4s ease, box-shadow 0.4s ease;
    }

    #lotesTable tbody tr:hover {
        background-color: #f8fafc;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        transform: scale(1.01);
    }

    #lotesTable tbody td {
        padding: 1rem;
        vertical-align: middle;
        font-size: 0.9rem;
    }

    .badge {
        font-weight: 600;
        font-size: 0.75rem;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
    }

    .btn-outline-primary {
        border-width: 1.5px;
        font-weight: 500;
        transition: all 0.2s;
    }

    .btn-outline-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .x-small {
        font-size: 0.75rem;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {

        .dataTables_wrapper .dataTables_filter,
        .dataTables_wrapper .dataTables_length {
            text-align: left;
            margin-bottom: 1rem;
        }
    }
</style>
{% endblock %}